#!/usr/bin/env bash

set -euo pipefail

current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "$current_script_path")")

# shellcheck source=./lib/utils.bash
source "${plugin_dir}/lib/utils.bash"

install_lychee() {
	local install_type="$1"
	local version="$2"
	local install_path="$3"

	if [ "$install_type" != "version" ]; then
		fail "asdf-$TOOL_NAME supports release installs only"
	fi

	# Create the bin directory
	local bin_path="${install_path}/bin"
	mkdir -p "$bin_path"

	# Find and move the lychee binary
	echo "* Installing lychee binary..."
	
	# The binary should be directly in ASDF_DOWNLOAD_PATH after extraction
	if [ -f "$ASDF_DOWNLOAD_PATH/lychee" ]; then
		cp "$ASDF_DOWNLOAD_PATH/lychee" "$bin_path/lychee"
	else
		fail "Could not find lychee binary in $ASDF_DOWNLOAD_PATH"
	fi

	# Make the binary executable
	chmod +x "$bin_path/lychee"

	# Verify installation
	echo "* Verifying installation..."
	if "$bin_path/lychee" --version >/dev/null 2>&1; then
		local installed_version
		installed_version=$("$bin_path/lychee" --version | head -n1)
		echo "* $TOOL_NAME $version installation was successful!"
		echo "* Installed: $installed_version"
	else
		fail "Installation verification failed. lychee --version did not execute successfully."
	fi
}

install_lychee "$ASDF_INSTALL_TYPE" "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"