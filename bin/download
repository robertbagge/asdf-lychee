#!/usr/bin/env bash

set -euo pipefail

current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "$current_script_path")")

# shellcheck source=./lib/utils.bash
source "${plugin_dir}/lib/utils.bash"

mkdir -p "$ASDF_DOWNLOAD_PATH"

# Detect platform and architecture
platform=$(get_platform)
arch=$(get_arch)

# Get the appropriate asset name for this platform/architecture
asset_name=$(get_asset_name "$platform" "$arch")

# Construct the download URL
version="$ASDF_INSTALL_VERSION"
url="https://github.com/lycheeverse/lychee/releases/download/lychee-v${version}/${asset_name}"

echo "* Downloading $TOOL_NAME $version for ${platform}-${arch}..."
echo "* Download URL: $url"

# Download the release file
release_file="$ASDF_DOWNLOAD_PATH/$asset_name"
curl "${curl_opts[@]}" -o "$release_file" -L "$url" || fail "Could not download $url"

# Extract the tarball
echo "* Extracting $asset_name..."
tar -xzf "$release_file" -C "$ASDF_DOWNLOAD_PATH" || fail "Could not extract $release_file"

# Remove the tarball after extraction
rm "$release_file"

echo "* Download and extraction completed successfully"